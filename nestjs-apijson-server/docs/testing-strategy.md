# APIJSON NestJS 项目测试策略文档

## 1. 项目架构分析

### 1.1 整体架构

本项目是基于 NestJS 的 APIJSON 服务器实现，采用模块化架构设计：

```
apijson-server/
├── src/
│   ├── modules/              # 业务模块
│   │   ├── parser/          # 请求解析模块
│   │   ├── verifier/        # 请求验证模块
│   │   ├── builder/         # SQL构建模块
│   │   ├── executor/        # 查询执行模块
│   │   ├── cache/           # 缓存模块
│   │   └── database/        # 数据库模块
│   ├── common/              # 通用组件
│   │   ├── guards/          # 守卫（认证、限流）
│   │   ├── pipes/           # 管道（验证）
│   │   ├── filters/         # 过滤器（异常处理）
│   │   ├── interceptors/    # 拦截器（日志、性能）
│   │   └── decorators/      # 装饰器
│   ├── controllers/         # 控制器
│   └── interfaces/          # 接口定义
```

### 1.2 核心业务流程

```
用户请求 → 验证管道 → 认证守卫 → 限流守卫 → 拦截器
    ↓
APIJSONController
    ↓
解析器(Parser) → 验证器(Verifier) → 构建器(Builder) → 执行器(Executor)
    ↓
缓存服务 → 数据库服务
    ↓
响应拦截器 → 异常过滤器 → 用户响应
```

## 2. 关键模块识别

### 2.1 高优先级模块（P0）

| 模块 | 功能 | 风险等级 | 测试优先级 |
|------|------|----------|-----------|
| ParserService | 解析APIJSON请求 | 高 | P0 |
| VerifierService | 验证请求合法性 | 高 | P0 |
| BuilderService | 构建SQL查询 | 极高 | P0 |
| APIJSONValidationPipe | 输入验证 | 高 | P0 |
| APIJSONAuthGuard | 认证守卫 | 极高 | P0 |

### 2.2 中优先级模块（P1）

| 模块 | 功能 | 风险等级 | 测试优先级 |
|------|------|----------|-----------|
| ExecutorService | 执行SQL查询 | 高 | P1 |
| CacheService | 缓存管理 | 中 | P1 |
| DatabaseService | 数据库操作 | 高 | P1 |
| APIJSONController | 主控制器 | 高 | P1 |
| APIJSONRateLimitGuard | 限流守卫 | 中 | P1 |

### 2.3 低优先级模块（P2）

| 模块 | 功能 | 风险等级 | 测试优先级 |
|------|------|----------|-----------|
| APIJSONInterceptor | 响应拦截 | 低 | P2 |
| LoggingInterceptor | 日志拦截 | 低 | P2 |
| APIJSONExceptionFilter | 异常过滤 | 中 | P2 |
| HealthController | 健康检查 | 低 | P2 |

## 3. 潜在风险点识别

### 3.1 安全风险

#### 3.1.1 SQL注入风险
**位置**: `BuilderService.buildWhereClause()`, `BuilderService.formatValue()`
**风险描述**: SQL构建过程中的参数化处理不当可能导致SQL注入
**测试重点**:
- 特殊字符转义测试
- 参数化查询验证
- 恶意输入过滤

#### 3.1.2 认证绕过风险
**位置**: `APIJSONAuthGuard.canActivate()`
**风险描述**: Token验证逻辑缺陷可能导致认证绕过
**测试重点**:
- 无效Token拒绝
- 过期Token拒绝
- 篡改Token拒绝
- 多种Token来源验证

#### 3.1.3 限流绕过风险
**位置**: `APIJSONRateLimitGuard.canActivate()`
**风险描述**: 内存存储的限流实现可能被绕过
**测试重点**:
- IP伪造检测
- 请求计数准确性
- 时间窗口边界

### 3.2 数据一致性风险

#### 3.2.1 缓存一致性
**位置**: `CacheService`
**风险描述**: LRU淘汰和过期处理可能导致数据不一致
**测试重点**:
- 缓存过期清理
- LRU淘汰逻辑
- 并发访问一致性

#### 3.2.2 数据库连接泄漏
**位置**: `DatabaseService`
**风险描述**: 连接未正确释放可能导致连接池耗尽
**测试重点**:
- 连接获取和释放
- 异常情况下的连接清理
- 连接池管理

### 3.3 业务逻辑风险

#### 3.3.1 解析器异常
**位置**: `ParserService.parse()`
**风险描述**: 恶意或格式错误的请求可能导致解析失败
**测试重点**:
- 空请求处理
- 循环引用检测
- 深度嵌套限制

#### 3.3.2 验证器绕过
**位置**: `VerifierService.verify()`
**风险描述**: 验证逻辑缺陷可能允许非法请求通过
**测试重点**:
- 表名验证
- 列名验证
- 条件验证
- 指令验证

### 3.4 性能风险

#### 3.4.1 缓存性能
**位置**: `CacheService`
**风险描述**: 缓存操作性能影响整体响应时间
**测试重点**:
- 大量数据缓存性能
- 缓存命中率
- 内存使用情况

#### 3.4.2 查询性能
**位置**: `ExecutorService.executeQuery()`
**风险描述**: 复杂查询可能导致性能问题
**测试重点**:
- 大数据集查询
- 复杂JOIN查询
- 分页性能

## 4. 测试边界条件

### 4.1 输入边界条件

| 测试场景 | 输入值 | 预期结果 |
|---------|--------|----------|
| 空请求 | `{}` | 返回空结果或错误 |
| 超长表名 | 65字符以上的表名 | 验证失败 |
| 特殊字符表名 | 包含`<>:"/\|?*`的表名 | 验证失败 |
| 以@开头的表名 | `@table` | 验证失败 |
| 空数组 | `[]` | 返回空结果 |
| 超大limit | `limit: 1001` | 验证失败 |
| 负数offset | `offset: -1` | 验证失败 |
| 无效HTTP方法 | `@method: 'INVALID'` | 验证失败 |
| 空Token | `token: ''` | 认证失败 |
| 过期Token | 过期的JWT | 认证失败 |

### 4.2 数据边界条件

| 测试场景 | 数据量 | 预期结果 |
|---------|--------|----------|
| 单条记录 | 1条 | 正常返回 |
| 空结果集 | 0条 | 返回空数组 |
| 默认分页 | 10条 | 正常返回 |
| 最大分页 | 1000条 | 正常返回 |
| 超过分页 | 1001条 | 验证失败 |
| 缓存满 | 1000条 | 触发LRU淘汰 |
| 缓存过期 | TTL过期 | 返回null |

### 4.3 并发边界条件

| 测试场景 | 并发数 | 预期结果 |
|---------|--------|----------|
| 单线程 | 1 | 正常处理 |
| 中等并发 | 10 | 正常处理 |
| 高并发 | 100 | 正常处理 |
| 极限并发 | 1000 | 可能限流或拒绝 |

### 4.4 网络边界条件

| 测试场景 | 网络状态 | 预期结果 |
|---------|----------|----------|
| 正常网络 | 延迟<100ms | 正常响应 |
| 慢速网络 | 延迟>1000ms | 可能超时 |
| 网络中断 | 连接断开 | 返回错误 |
| 网络恢复 | 连接恢复 | 恢复正常 |

## 5. 单元测试策略

### 5.1 测试覆盖率目标

| 模块类型 | 覆盖率目标 | 说明 |
|---------|-----------|------|
| 核心业务模块 | ≥90% | Parser, Verifier, Builder, Executor |
| 安全相关模块 | ≥95% | Guards, Pipes, Filters |
| 缓存和数据库 | ≥85% | CacheService, DatabaseService |
| 拦截器和控制器 | ≥80% | Interceptors, Controllers |
| 工具类 | 100% | Utils, Helpers |

### 5.2 测试金字塔

```
        /\
       /E2E\          端到端测试 (5%)
      /------\
     / 集成测试 \       集成测试 (15%)
    /----------\
   /  单元测试   \      单元测试 (80%)
  /--------------\
```

### 5.3 单元测试分类

#### 5.3.1 正常流程测试
- 标准输入验证
- 正常业务流程
- 预期输出验证

#### 5.3.2 异常流程测试
- 无效输入处理
- 异常情况处理
- 错误消息验证

#### 5.3.3 边界条件测试
- 最小值/最大值
- 空值/null值
- 特殊字符处理

#### 5.3.4 性能测试
- 执行时间验证
- 内存使用验证
- 并发性能验证

## 6. Mock策略

### 6.1 外部依赖Mock

| 依赖 | Mock方式 | 原因 |
|------|---------|------|
| DatabaseService | Mock对象 | 避免真实数据库连接 |
| CacheService | Mock对象 | 避免真实缓存操作 |
| JwtService | Mock对象 | 避免真实JWT验证 |
| Logger | Mock对象 | 避免日志输出干扰 |
| ConfigService | Mock对象 | 控制测试环境配置 |

### 6.2 Mock实现原则

1. **隔离性**: 每个测试独立运行，不依赖其他测试
2. **可重复性**: 相同输入产生相同输出
3. **快速执行**: Mock操作应快速完成
4. **真实模拟**: Mock行为应尽可能接近真实行为

## 7. 测试执行规范

### 7.1 测试文件命名规范

```
src/
├── modules/
│   ├── parser/
│   │   ├── parser.service.ts
│   │   └── parser.service.spec.ts    # 单元测试
├── common/
│   ├── guards/
│   │   ├── apijson-auth.guard.ts
│   │   └── apijson-auth.guard.spec.ts
└── test/
    ├── unit/                          # 单元测试
    ├── integration/                   # 集成测试
    └── e2e/                           # 端到端测试
```

### 7.2 测试用例命名规范

```typescript
describe('ParserService', () => {
  describe('parse', () => {
    it('should parse valid APIJSON request', () => {});
    it('should throw error for invalid table name', () => {});
    it('should handle empty request', () => {});
  });
});
```

### 7.3 测试执行命令

```bash
# 运行所有单元测试
npm run test:unit

# 运行特定模块测试
npm run test:unit -- parser

# 运行测试并生成覆盖率报告
npm run test:cov

# 监听模式运行测试
npm run test:watch

# 运行集成测试
npm run test:integration

# 运行端到端测试
npm run test:e2e
```

## 8. 持续集成测试

### 8.1 CI/CD集成

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run test:unit
      - run: npm run test:cov
      - uses: codecov/codecov-action@v2
```

### 8.2 质量门禁

| 指标 | 阈值 | 说明 |
|------|------|------|
| 单元测试通过率 | 100% | 所有单元测试必须通过 |
| 代码覆盖率 | ≥80% | 整体覆盖率不低于80% |
| 核心模块覆盖率 | ≥90% | 核心模块覆盖率不低于90% |
| 测试执行时间 | ≤5分钟 | 单元测试执行时间不超过5分钟 |

## 9. 测试维护指南

### 9.1 测试代码审查清单

- [ ] 测试用例是否覆盖所有关键路径
- [ ] 测试用例是否包含边界条件
- [ ] Mock对象是否合理
- [ ] 测试是否独立可运行
- [ ] 测试命名是否清晰
- [ ] 测试断言是否充分

### 9.2 测试更新时机

- 新增功能时：同步添加测试用例
- 修改功能时：更新相关测试用例
- 修复Bug时：添加回归测试
- 重构代码时：确保测试通过

### 9.3 测试文档维护

- 测试策略文档：每季度更新
- 测试用例文档：随代码变更更新
- 测试覆盖率报告：每次构建生成
- 测试结果报告：每次测试后生成

## 10. 测试工具链

### 10.1 核心工具

| 工具 | 用途 | 版本 |
|------|------|------|
| Vitest | 单元测试框架 | ^4.0.16 |
| @vitest/coverage-v8 | 覆盖率工具 | ^1.0.0 |
| Supertest | HTTP测试 | ^7.1.4 |
| @nestjs/testing | NestJS测试工具 | ^11.1.11 |

### 10.2 辅助工具

| 工具 | 用途 | 版本 |
|------|------|------|
| ts-mockito | Mock框架 | ^2.6.1 |
| faker | 测试数据生成 | ^8.4.0 |
| @faker-js/faker | 测试数据生成 | ^8.4.0 |

## 11. 总结

本测试策略文档为APIJSON NestJS项目提供了全面的测试指导，包括：

1. **架构分析**: 明确了项目的模块化架构和核心业务流程
2. **风险识别**: 识别了安全、数据一致性、业务逻辑和性能风险
3. **边界条件**: 定义了输入、数据、并发和网络边界条件
4. **测试策略**: 制定了单元测试、集成测试和端到端测试策略
5. **Mock策略**: 规范了外部依赖的Mock实现
6. **执行规范**: 制定了测试文件命名、用例命名和执行命令规范
7. **CI/CD集成**: 定义了持续集成测试流程和质量门禁
8. **维护指南**: 提供了测试代码审查清单和更新时机

通过遵循本测试策略，可以确保项目的高质量和稳定性。
