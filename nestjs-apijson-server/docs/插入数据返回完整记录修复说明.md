# 插入数据返回完整记录修复说明

## 问题描述

之前在执行 POST /apijson/post 新增数据时，返回的数据只包含数组索引序号，而不是数据库中实际插入的完整记录。例如：

```json
{
  "status": "success",
  "data": {
    "user": [
      {
        "name": "张三",
        "age": 25,
        "id": 0  // 错误：这是索引，不是数据库生成的 ID
      }
    ]
  }
}
```

期望的返回应该是：

```json
{
  "status": "success",
  "data": {
    "user": [
      {
        "id": 123,  // 正确：数据库生成的 ID
        "name": "张三",
        "age": 25,
        "created_at": "2026-01-02T02:30:00.000Z",
        "updated_at": "2026-01-02T02:30:00.000Z"
      }
    ]
  }
}
```

## 问题原因

在 [`mysql-executor.service.ts`](../src/modules/executor/mysql-executor.service.ts) 的 `executeInsert` 方法中，只是简单地将插入的数据和 insertId 合并返回：

```typescript
// 旧代码
return {
  data: [
    {
      ...query.data,
      id: insertId,
    },
  ],
  total: 1,
  count: 1,
};
```

这种方式的问题：
1. 只返回了插入时提供的字段
2. 没有包含数据库自动生成的字段（如 `created_at`、`updated_at`）
3. 没有包含其他默认值字段
4. 批量插入时的 ID 计算可能不准确

## 修复方案

### 1. 新增 `queryInsertedRecords` 方法

新增一个方法来查询数据库中插入的完整记录：

```typescript
/**
 * 查询插入的记录
 * @param table 表名
 * @param ids 插入的 ID 列表
 * @returns 插入的完整记录
 */
private async queryInsertedRecords(table: string, ids: number[]): Promise<any[]> {
  this.logger.debug(`查询插入的记录: ${table}, IDs: ${ids.join(', ')}`);

  if (ids.length === 0) {
    return [];
  }

  // 构建 SELECT 查询，获取所有字段
  const placeholders = ids.map(() => '?').join(',');
  const sql = `SELECT * FROM \`${table}\` WHERE id IN (${placeholders})`;
  
  try {
    const result = await this.databaseService.query(sql, ids);
    const rows = this.extractRows(result);
    
    this.logger.debug(`查询到 ${rows.length} 条记录`);
    return rows;
  } catch (error) {
    this.logger.error(`查询插入记录失败: ${error.message}`, error.stack);
    // 如果查询失败，返回包含 ID 的原始数据
    return ids.map(id => ({ id }));
  }
}
```

### 2. 修改 `executeInsert` 方法

修改插入方法，在插入后查询数据库获取完整记录：

```typescript
/**
 * 执行 INSERT 查询
 */
private async executeInsert(query: Query): Promise<QueryExecuteResult> {
  this.logger.debug(`执行 INSERT 查询: ${query.table}`);

  const result = await this.databaseService.query(query.sql, query.params);
  const insertId = this.extractInsertId(result);

  // 如果是批量插入，返回所有插入的 ID
  if (Array.isArray(query.data) && query.data.length > 1) {
    const insertIds = [insertId];
    for (let i = 1; i < query.data.length; i++) {
      insertIds.push(insertId + i);
    }

    // 批量插入时，查询所有插入的记录
    const insertedData = await this.queryInsertedRecords(query.table, insertIds);

    return {
      data: insertedData,
      total: insertIds.length,
      count: insertIds.length,
    };
  }

  // 单条插入，查询插入的完整记录
  const insertedData = await this.queryInsertedRecords(query.table, [insertId]);

  return {
    data: insertedData,
    total: 1,
    count: 1,
  };
}
```

## 修复后的效果

### 单条插入

**请求**：
```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/post' \
  -H 'Content-Type: application/json' \
  -d '{
  "user": {
    "name": "张三",
    "age": 25
  }
}'
```

**响应**：
```json
{
  "status": "success",
  "code": 200,
  "message": "请求成功",
  "data": {
    "user": [
      {
        "id": 123,
        "name": "张三",
        "age": 25,
        "created_at": "2026-01-02T02:30:00.000Z",
        "updated_at": "2026-01-02T02:30:00.000Z"
      }
    ]
  },
  "processingTime": 15,
  "timestamp": "2026-01-02T02:30:15.000Z",
  "path": "/apijson/post",
  "cached": false
}
```

### 批量插入

**请求**：
```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/post' \
  -H 'Content-Type: application/json' \
  -d '{
  "user[]": [
    {
      "name": "张三",
      "age": 25
    },
    {
      "name": "李四",
      "age": 26
    }
  ]
}'
```

**响应**：
```json
{
  "status": "success",
  "code": 200,
  "message": "请求成功",
  "data": {
    "user": [
      {
        "id": 123,
        "name": "张三",
        "age": 25,
        "created_at": "2026-01-02T02:30:00.000Z",
        "updated_at": "2026-01-02T02:30:00.000Z"
      },
      {
        "id": 124,
        "name": "李四",
        "age": 26,
        "created_at": "2026-01-02T02:30:00.000Z",
        "updated_at": "2026-01-02T02:30:00.000Z"
      }
    ]
  },
  "processingTime": 20,
  "timestamp": "2026-01-02T02:30:20.000Z",
  "path": "/apijson/post",
  "cached": false
}
```

## 优势

1. **完整性** - 返回数据库中的完整记录，包括所有字段
2. **准确性** - ID 和其他自动生成的字段准确无误
3. **一致性** - 与查询操作返回的数据格式一致
4. **实用性** - 客户端可以直接使用返回的数据，无需额外查询

## 注意事项

1. **性能影响** - 每次插入后会执行一次 SELECT 查询，会略微影响性能
2. **事务处理** - 如果使用事务，需要在事务提交后查询
3. **错误处理** - 如果查询失败，会返回包含 ID 的最小数据
4. **表结构** - 假设表有 `id` 字段作为主键

## 日志输出

修复后，日志会显示查询插入记录的过程：

```
[MySQLExecutorService] 执行 INSERT 查询: user
[MySQLExecutorService] 查询插入的记录: user, IDs: 123
[MySQLExecutorService] 查询到 1 条记录
```

## 相关文件

- [`src/modules/executor/mysql-executor.service.ts`](../src/modules/executor/mysql-executor.service.ts) - MySQL 执行器服务
- [`src/modules/database/database.service.ts`](../src/modules/database/database.service.ts) - 数据库服务

## 测试建议

建议测试以下场景：

1. 单条插入 - 验证返回完整记录
2. 批量插入 - 验证所有记录都正确返回
3. 包含默认值的字段 - 验证默认值正确返回
4. 自动生成的时间戳 - 验证时间戳正确返回
5. 表没有 id 字段 - 验证错误处理
