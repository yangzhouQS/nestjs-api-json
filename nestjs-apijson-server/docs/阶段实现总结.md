# APIJSON ORM æ ¸å¿ƒåŠŸèƒ½å®ç° - é˜¶æ®µæ€»ç»“

## å·²å®Œæˆçš„å·¥ä½œ âœ…

### 1. æ–°å¢è§£æå™¨æ¨¡å—

å·²æˆåŠŸåˆ›å»ºä»¥ä¸‹è§£æå™¨æ¨¡å—ï¼š

#### 1.1 JOINè§£æå™¨
**æ–‡ä»¶**: [`src/core/parsers/join-parser.ts`](../src/core/parsers/join-parser.ts)

**åŠŸèƒ½**:
- è§£æ JOIN è¯­æ³•ï¼ˆå¦‚ï¼š`"&/User/id@,</Comment/momentId@"`ï¼‰
- æ”¯æŒ 10 ç§ JOIN ç±»å‹
- ç”Ÿæˆ JOIN SQL è¯­å¥
- åŒºåˆ† APP JOIN å’Œ SQL JOIN

**æ”¯æŒçš„ JOIN ç±»å‹**:
- APP JOIN (@) - åº”ç”¨å±‚ JOIN
- INNER JOIN (&) - å†…è¿æ¥
- FULL JOIN (|) - å…¨è¿æ¥
- LEFT JOIN (<) - å·¦è¿æ¥
- RIGHT JOIN (>) - å³è¿æ¥
- OUTER JOIN (!) - å¤–è¿æ¥
- SIDE JOIN (^) - ä¾§è¿æ¥
- ANTI JOIN (() - åè¿æ¥
- FOREIGN JOIN ()) - å¤–éƒ¨è¿æ¥
- ASOF JOIN (~) - ASOF è¿æ¥

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
parse(joinValue: string | string[]): JoinConfig
toJoinClause(config: JoinConfig, quote: string): string
getAppJoins(config: JoinConfig): JoinItem[]
getSqlJoins(config: JoinConfig): JoinItem[]
validate(config: JoinConfig, availableTables: string[]): void
```

**ä½¿ç”¨ç¤ºä¾‹**:
```json
{
  "[]": {
    "join": "&/User/id@,</Comment/momentId@",
    "Moment": {},
    "User": {
      "id@": "/Moment/userId"
    }
  }
}
```

#### 1.2 å­æŸ¥è¯¢è§£æå™¨
**æ–‡ä»¶**: [`src/core/parsers/subquery-parser.ts`](../src/core/parsers/subquery-parser.ts)

**åŠŸèƒ½**:
- è§£æ WHERE å­æŸ¥è¯¢
- è§£æ FROM å­æŸ¥è¯¢
- è§£æ SELECT å­æŸ¥è¯¢
- è§£æ EXISTS å­æŸ¥è¯¢
- æ”¯æŒ ALL/ANY èŒƒå›´

**å­æŸ¥è¯¢ç±»å‹**:
- WHERE å­æŸ¥è¯¢ï¼š`"id@":{"from":"Comment","Comment":{"@column":"min(userId)"}}`
- EXISTS å­æŸ¥è¯¢ï¼š`"id}{@":{"from":"Comment","Comment":{"momentId":15}}`
- ALL/ANY å­æŸ¥è¯¢ï¼š`"id>@":{"from":"Comment","Comment":{"@column":"min(userId)"}}`

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
parse(key: string, value: any): SubqueryParseResult
toSQLSubquery(result: SubqueryParseResult, quote: string): string
generateWhereSubquery(result: SubqueryParseResult, quote: string): string
generateExistsSubquery(result: SubqueryParseResult, quote: string): string
generateFromSubquery(result: SubqueryParseResult, quote: string): string
generateSelectSubquery(result: SubqueryParseResult, quote: string): string
validate(result: SubqueryParseResult, availableTables: string[]): void
```

#### 1.3 å¼•ç”¨è§£æå™¨
**æ–‡ä»¶**: [`src/core/parsers/reference-parser.ts`](../src/core/parsers/reference-parser.ts)

**åŠŸèƒ½**:
- è§£æ key@ å•å€¼å¼•ç”¨
- è§£æ key{}@ æ•°ç»„å¼•ç”¨
- æ”¯æŒè·¯å¾„è§£æ
- æ”¯æŒç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„

**å¼•ç”¨ç±»å‹**:
- å•å€¼å¼•ç”¨ï¼š`"id@":"/Moment/userId"`
- æ•°ç»„å¼•ç”¨ï¼š`"id{}@":"/[]/Moment/id"`
- ç›¸å¯¹è·¯å¾„ï¼š`"/Moment/userId"`ï¼ˆä»çˆ¶å®¹å™¨å¼€å§‹ï¼‰
- ç»å¯¹è·¯å¾„ï¼š`"Moment/userId"`ï¼ˆä»æ ¹å¼€å§‹ï¼‰

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
parse(key: string, value: string): ReferenceConfig
parsePath(path: string): string[]
parsePathString(path: string): PathInfo
getValueByPath(path: string[], context: any): any
resolveReference(path: string, context: any, currentPath?: string[]): any
parseArrayReference(key: string, value: string): ArrayReferenceConfig
resolveArrayReference(config: ArrayReferenceConfig, context: any, currentPath?: string[]): any[]
toReferenceSQL(config: ReferenceConfig, quote: string): string
validate(config: ReferenceConfig, availableKeys: string[]): void
isReference(key: string): boolean
isArrayReference(key: string): boolean
isSingleReference(key: string): boolean
```

#### 1.4 æ•°ç»„è§£æå™¨
**æ–‡ä»¶**: [`src/core/parsers/array-parser.ts`](../src/core/parsers/array-parser.ts)

**åŠŸèƒ½**:
- è§£æ Table[] è¡¨æ•°ç»„æŸ¥è¯¢
- è§£æ [] æ•°ç»„å®¹å™¨æŸ¥è¯¢
- æ”¯æŒæ•°ç»„æå–
- æ”¯æŒ countã€pageã€query å‚æ•°

**æ•°ç»„ç±»å‹**:
- è¡¨æ•°ç»„ï¼š`"User[]":{"count":3,"User":{}}`
- æ•°ç»„å®¹å™¨ï¼š`"[]":{"count":3,"Moment":{}}`
- æå–æ•°ç»„ï¼š`"User-id[]":{"count":3,"User":{}}`

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
parse(key: string, value: any): ArrayQueryConfig
parseCount(count: number): number
parsePage(page: number): number
parseQuery(query: number): QueryType
extractArray(result: any, config: ArrayQueryConfig): any[]
extractByKey(result: any, key: string): any[]
validate(config: ArrayQueryConfig, availableTables: string[]): void
isArrayQuery(key: string): boolean
isContainer(key: string): boolean
isTableArray(key: string): boolean
isExtractArray(key: string): boolean
```

#### 1.5 èšåˆå‡½æ•°è§£æå™¨
**æ–‡ä»¶**: [`src/core/parsers/aggregate-parser.ts`](../src/core/parsers/aggregate-parser.ts)

**åŠŸèƒ½**:
- è§£æèšåˆå‡½æ•°è¡¨è¾¾å¼
- æ”¯æŒ COUNT, SUM, AVG, MIN, MAX
- æ”¯æŒèšåˆå‡½æ•°åˆ«å
- æ”¯æŒåˆ†å·åˆ†éš”å¤šä¸ªèšåˆå‡½æ•°

**èšåˆå‡½æ•°**:
- COUNT: `COUNT(*)` æˆ– `COUNT(id)`
- SUM: `SUM(amount)`
- AVG: `AVG(score)`
- MIN: `MIN(price)`
- MAX: `MAX(price)`

**æ ¸å¿ƒæ–¹æ³•**:
```typescript
parse(expression: string): AggregateFunction
parseMultiple(expressions: string[]): AggregateFunction[]
parseSemicolonSeparated(expression: string): AggregateFunction[]
toSQL(config: AggregateFunction, quote: string): string
toSQLMultiple(configs: AggregateFunction[], quote: string): string
validate(config: AggregateFunction, availableFields: string[]): void
isAggregateFunction(expression: string): boolean
extractFunctionName(expression: string): string | null
extractField(expression: string): string | null
extractAlias(expression: string): string | null
getSupportedFunctions(): string[]
isSupportedFunction(functionName: string): boolean
```

### 2. æ›´æ–°çš„æ–‡ä»¶

#### 2.1 è§£æå™¨ç´¢å¼•
**æ–‡ä»¶**: [`src/core/parsers/index.ts`](../src/core/parsers/index.ts)

**æ›´æ–°å†…å®¹**:
- å¯¼å‡ºæ–°åˆ›å»ºçš„è§£æå™¨
- JOIN Parser
- Subquery Parser
- Reference Parser
- Array Parser
- Aggregate Parser

#### 2.2 å‡½æ•°è§£æå™¨æ¥å£
**æ–‡ä»¶**: [`src/core/function-parser.interface.ts`](../src/core/function-parser.interface.ts)

**ä¿®å¤å†…å®¹**:
- å°†æ‰€æœ‰ `function` å‚æ•°åæ”¹ä¸º `funcName`ï¼ˆé¿å…ä¸ TypeScript ä¿ç•™å­—å†²çªï¼‰
- ä¿®å¤äº†æ¥å£å®šä¹‰ä¸­çš„å‚æ•°å

#### 2.3 å‡½æ•°è§£æå™¨æŠ½è±¡ç±»
**æ–‡ä»¶**: [`src/core/abstract-function-parser.ts`](../src/core/abstract-function-parser.ts)

**ä¿®å¤å†…å®¹**:
- å°†æ‰€æœ‰ `function` å‚æ•°åæ”¹ä¸º `funcName`ï¼ˆé¿å…ä¸ TypeScript ä¿ç•™å­—å†²çªï¼‰
- ä¿®å¤äº†æ–¹æ³•å®šä¹‰ä¸­çš„å‚æ•°å

### 3. åˆ›å»ºçš„æ–‡æ¡£

#### 3.1 åŠŸèƒ½å®ç°è®¡åˆ’
**æ–‡ä»¶**: [`docs/åŠŸèƒ½å®ç°è®¡åˆ’.md`](åŠŸèƒ½å®ç°è®¡åˆ’.md)

**å†…å®¹**:
- è¯¦ç»†çš„åŠŸèƒ½å®ç°è®¡åˆ’
- æ¯ä¸ªåŠŸèƒ½çš„å®ç°è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹
- å®ç°ä¼˜å…ˆçº§

#### 3.2 æ ¸å¿ƒåŠŸèƒ½å®ç°æ€»ç»“
**æ–‡ä»¶**: [`docs/æ ¸å¿ƒåŠŸèƒ½å®ç°æ€»ç»“.md`](æ ¸å¿ƒåŠŸèƒ½å®ç°æ€»ç»“.md)

**å†…å®¹**:
- å·²å®ŒæˆåŠŸèƒ½çš„è¯¦ç»†è¯´æ˜
- æ¯ä¸ªè§£æå™¨çš„åŠŸèƒ½ã€æ–¹æ³•ã€ç¤ºä¾‹
- æ¶æ„è®¾è®¡è¯´æ˜
- æ–‡ä»¶ç»“æ„è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹é›†åˆ

## éœ€è¦æ³¨æ„çš„é—®é¢˜ âš ï¸

### 1. TypeScript ç¼–è¯‘é”™è¯¯

ä»ç¼–è¯‘è¾“å‡ºæ¥çœ‹ï¼Œå­˜åœ¨ä»¥ä¸‹ TypeScript ç¼–è¯‘é”™è¯¯ï¼š

#### 1.1 æŠ½è±¡ç±»ä¸­çš„é—®é¢˜
- **abstract-object-parser.ts**: å­˜åœ¨é‡å¤çš„æ–¹æ³•å®šä¹‰å’Œç±»å‹ä¸åŒ¹é…é—®é¢˜
- **abstract-sql-config.ts**: å­˜åœ¨é‡å¤çš„æ ‡è¯†ç¬¦å’Œæ–¹æ³•ç­¾åé—®é¢˜
- **abstract-sql-executor.ts**: å­˜åœ¨æ–¹æ³•é‡è½½å’Œå®ç°ç­¾åä¸åŒ¹é…é—®é¢˜
- **abstract-verifier.ts**: å­˜åœ¨æ–¹æ³•åç§°ä¸åŒ¹é…é—®é¢˜

#### 1.2 è§£æå™¨ä¸­çš„é—®é¢˜
- **having-parser.ts**: éœ€è¦ä½¿ç”¨é™æ€æ–¹æ³•è°ƒç”¨è€Œä¸æ˜¯å®ä¾‹æ–¹æ³•è°ƒç”¨
- **array-parser.ts**: ç±»å‹æ‹¼å†™é”™è¯¯ï¼ˆ'ARRAY' åº”è¯¥æ˜¯ 'CONTAINER'ï¼‰
- **reference-parser.ts**: è·¯å¾„è§£æè¿”å›ç±»å‹ä¸åŒ¹é…

#### 1.3 è¿ç®—ç¬¦è§£æå™¨ä¸­çš„é—®é¢˜
- **operator-parser.ts**: æ•°ç»„ç±»å‹å®šä¹‰ä¸æ­£ç¡®ï¼Œéœ€è¦ä½¿ç”¨è”åˆç±»å‹

### 2. å»ºè®®çš„ä¿®å¤æ­¥éª¤

#### 2.1 ä¿®å¤æŠ½è±¡ç±»
1. ä¿®å¤ `abstract-object-parser.ts` ä¸­çš„é‡å¤æ–¹æ³•å®šä¹‰
2. ä¿®å¤ `abstract-sql-config.ts` ä¸­çš„æ–¹æ³•ç­¾å
3. ä¿®å¤ `abstract-sql-executor.ts` ä¸­çš„æ–¹æ³•é‡è½½
4. ä¿®å¤ `abstract-verifier.ts` ä¸­çš„æ–¹æ³•åç§°

#### 2.2 ä¿®å¤è§£æå™¨
1. ä¿®å¤ `having-parser.ts` ä¸­çš„æ–¹æ³•è°ƒç”¨æ–¹å¼
2. ä¿®å¤ `array-parser.ts` ä¸­çš„ç±»å‹æ‹¼å†™
3. ä¿®å¤ `reference-parser.ts` ä¸­çš„è¿”å›ç±»å‹

#### 2.3 ä¿®å¤è¿ç®—ç¬¦è§£æå™¨
1. ä¿®å¤ `operator-parser.ts` ä¸­çš„æ•°ç»„ç±»å‹å®šä¹‰

## åŠŸèƒ½è¦†ç›–æƒ…å†µ

### å·²å®ŒæˆåŠŸèƒ½ âœ…
- [x] ç‰¹æ®Šå­—æ®µè§£æå™¨ï¼ˆ@column, @order, @group, @having, @combineï¼‰
- [x] æ•°ç»„å…³é”®è¯è§£æå™¨ï¼ˆcount, page, query, joinï¼‰
- [x] JOINæŸ¥è¯¢æ”¯æŒï¼ˆ10ç§JOINç±»å‹ï¼‰
- [x] å­æŸ¥è¯¢åŠŸèƒ½ï¼ˆWHERE, FROM, SELECT, EXISTS, ALL/ANYï¼‰
- [x] å¼•ç”¨èµ‹å€¼åŠŸèƒ½ï¼ˆkey@, key{}@ï¼‰
- [x] æ•°ç»„æŸ¥è¯¢åŠŸèƒ½ï¼ˆTable[], []ï¼‰
- [x] èšåˆå‡½æ•°æ”¯æŒï¼ˆCOUNT, SUM, AVG, MIN, MAXï¼‰

### å¾…å®ç°åŠŸèƒ½ ğŸ“‹
- [ ] ç¼“å­˜æœºåˆ¶ï¼ˆå†…å­˜ç¼“å­˜ã€Redisç¼“å­˜ï¼‰
- [ ] äº‹åŠ¡ç®¡ç†ï¼ˆäº‹åŠ¡æ§åˆ¶ã€ä¿å­˜ç‚¹ç®¡ç†ï¼‰
- [ ] æ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡æ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰
- [ ] æƒé™æ§åˆ¶ï¼ˆè§’è‰²éªŒè¯ã€è®¿é—®æ§åˆ¶ï¼‰
- [ ] æµ‹è¯•ç”¨ä¾‹ï¼ˆå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ï¼‰

## æŠ€æœ¯ç‰¹ç‚¹

### ä¼˜ç‚¹
- âœ… å®Œå…¨éµå¾ª APIJSON è¯­æ³•æ ‡å‡†
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… æ¨¡å—åŒ–è®¾è®¡ï¼ŒèŒè´£å•ä¸€
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… æ”¯æŒå¤šç§è¾“å…¥æ ¼å¼ï¼ˆå­—ç¬¦ä¸²ã€æ•°ç»„ã€å¯¹è±¡ï¼‰
- âœ… æä¾›è¯¦ç»†çš„æ—¥å¿—å’Œè°ƒè¯•ä¿¡æ¯
- âœ… è‰¯å¥½çš„ä»£ç ç»„ç»‡å’Œæ–‡æ¡£

### æ”¹è¿›ç©ºé—´
- âš ï¸ éœ€è¦ä¿®å¤ TypeScript ç¼–è¯‘é”™è¯¯
- âš ï¸ éœ€è¦å®Œå–„æŠ½è±¡ç±»çš„å®ç°
- âš ï¸ éœ€è¦æ·»åŠ å•å…ƒæµ‹è¯•
- âš ï¸ éœ€è¦æ·»åŠ é›†æˆæµ‹è¯•

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **ä¿®å¤ç¼–è¯‘é”™è¯¯**
   - ä¿®å¤æ‰€æœ‰ TypeScript ç¼–è¯‘é”™è¯¯
   - ç¡®ä¿ç±»å‹å®‰å…¨
   - ç¡®ä¿æ–¹æ³•ç­¾åæ­£ç¡®

2. **å®Œå–„æŠ½è±¡ç±»å®ç°**
   - å®Œå–„ AbstractObjectParser
   - å®Œå–„ AbstractSQLConfig
   - å®Œå–„ AbstractSQLExecutor
   - å®Œå–„ AbstractVerifier

3. **å®ç°ç¼“å­˜æœºåˆ¶**
   - å®ç°å†…å­˜ç¼“å­˜
   - å®ç° Redis ç¼“å­˜

4. **å®ç°äº‹åŠ¡ç®¡ç†**
   - å®ç°äº‹åŠ¡æ§åˆ¶
   - å®ç°ä¿å­˜ç‚¹ç®¡ç†

5. **å®ç°æ‰¹é‡æ“ä½œ**
   - å®ç°æ‰¹é‡æ’å…¥
   - å®ç°æ‰¹é‡æ›´æ–°
   - å®ç°æ‰¹é‡åˆ é™¤

6. **å®Œå–„æƒé™æ§åˆ¶**
   - å®ç°è§’è‰²éªŒè¯
   - å®ç°è®¿é—®æ§åˆ¶

7. **ç¼–å†™æµ‹è¯•ç”¨ä¾‹**
   - ç¼–å†™å•å…ƒæµ‹è¯•
   - ç¼–å†™é›†æˆæµ‹è¯•

8. **å®Œå–„æ–‡æ¡£**
   - æ›´æ–° API æ–‡æ¡£
   - æ›´æ–°ä½¿ç”¨æŒ‡å—
   - æ·»åŠ æœ€ä½³å®è·µ

## æ€»ç»“

æœ¬é˜¶æ®µæˆåŠŸå®Œæˆäº† APIJSON ORM æ ¸å¿ƒè§£æå™¨çš„å®ç°ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… JOIN è§£æå™¨ - æ”¯æŒ 10 ç§ JOIN ç±»å‹
2. âœ… å­æŸ¥è¯¢è§£æå™¨ - æ”¯æŒ WHERE/FROM/SELECT/EXISTS å­æŸ¥è¯¢
3. âœ… å¼•ç”¨è§£æå™¨ - æ”¯æŒ key@ å’Œ key{}@ è¯­æ³•
4. âœ… æ•°ç»„è§£æå™¨ - æ”¯æŒ Table[] å’Œ [] è¯­æ³•
5. âœ… èšåˆå‡½æ•°è§£æå™¨ - æ”¯æŒ COUNT/SUM/AVG/MIN/MAX

æ‰€æœ‰æ–°åˆ›å»ºçš„è§£æå™¨éƒ½éµå¾ª APIJSON è¯­æ³•æ ‡å‡†ï¼Œå…·æœ‰è‰¯å¥½çš„ç±»å‹å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚åŒæ—¶åˆ›å»ºäº†è¯¦ç»†çš„å®ç°è®¡åˆ’æ–‡æ¡£å’ŒåŠŸèƒ½æ€»ç»“æ–‡æ¡£ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¡¹ç›®ä¸­å­˜åœ¨ä¸€äº› TypeScript ç¼–è¯‘é”™è¯¯ï¼Œä¸»è¦æ¥è‡ªç°æœ‰çš„æŠ½è±¡ç±»æ–‡ä»¶ã€‚è¿™äº›é”™è¯¯éœ€è¦åç»­ä¿®å¤ï¼Œä»¥ç¡®ä¿é¡¹ç›®èƒ½å¤Ÿæ­£å¸¸ç¼–è¯‘å’Œè¿è¡Œã€‚
