# 列名验证修复说明

## 问题描述

在使用 POST 方法添加数据时，出现以下错误：

```json
{
  "status": "error",
  "code": 400,
  "message": "请求验证失败",
  "errors": [
    "列 \"*\" 包含非法字符"
  ]
}
```

## 问题原因

在 `src/modules/verifier/verifier.service.ts` 文件中，验证列名的正则表达式 `/[<>:"\\|?*\x00-\x1f]/` 将 `*` 字符识别为非法字符。

但在 SQL 中，`*` 是一个特殊的通配符，表示"所有列"，应该被允许使用。

## 修复方案

### 1. 修复 `verifyColumns` 方法

在验证列名时，添加对 `*` 的特殊处理：

```typescript
private async verifyColumns(columns: any): Promise<string[]> {
  const errors: string[] = [];

  // 检查是否为数组或字符串
  if (!Array.isArray(columns) && typeof columns !== 'string') {
    errors.push('列必须为数组或字符串');
    return errors;
  }

  // 如果是字符串，转换为数组
  if (typeof columns === 'string') {
    columns = columns.split(',');
  }

  // 验证每个列
  for (const column of columns) {
    if (typeof column !== 'string') {
      errors.push(`列 "${column}" 必须为字符串`);
      continue;
    }

    // * 是 SQL 通配符，表示所有列，应该被允许
    if (column === '*') {
      continue;
    }

    // 检查是否包含非法字符（排除 *，因为它是 SQL 通配符）
    const invalidChars = /[<>:"\\|?\x00-\x1f]/;
    if (invalidChars.test(column)) {
      errors.push(`列 "${column}" 包含非法字符`);
    }
  }

  return errors;
}
```

### 2. 修复 `verifyGroup` 方法

从正则表达式中移除 `*` 字符：

```typescript
// 修改前
const invalidChars = /[<>:"\\|?*\x00-\x1f]/;

// 修改后
const invalidChars = /[<>:"\\|?\x00-\x1f]/;
```

### 3. 修复 `verifyOrder` 方法

从正则表达式中移除 `*` 字符：

```typescript
// 修改前
const invalidChars = /[<>:"\\|?*\x00-\x1f]/;

// 修改后
const invalidChars = /[<>:"\\|?\x00-\x1f]/;
```

## 修复后的行为

修复后，以下请求应该能够正常工作：

### 添加数据（POST）

```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/post' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "user": {
    "name": "张三",
    "age": 25
  }
}'
```

### 查询数据（GET）

```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/get' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "user": {
    "id": 1,
    "@column": "id,name,age"
  }
}'
```

### 查询所有列（使用 *）

```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/get' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "user": {
    "id": 1,
    "@column": "*"
  }
}'
```

## 测试

已创建测试文件 `test/verifier-fix.test.ts` 来验证修复：

```typescript
describe('VerifierService - * 字符处理', () => {
  it('应该允许 * 作为列名（SQL 通配符）', async () => {
    const errors = await verifierService.verifyColumns(['*']);
    expect(errors).toHaveLength(0);
  });

  it('应该允许字符串中的 *', async () => {
    const errors = await verifierService.verifyColumns('*');
    expect(errors).toHaveLength(0);
  });

  it('应该拒绝包含其他非法字符的列名', async () => {
    const errors = await verifierService.verifyColumns(['id<name']);
    expect(errors.length).toBeGreaterThan(0);
  });
});
```

## 影响范围

此修复影响以下功能：

1. **列名验证** - 允许使用 `*` 作为列名
2. **分组验证** - 允许在 GROUP BY 中使用 `*`
3. **排序验证** - 允许在 ORDER BY 中使用 `*`

## 注意事项

1. `*` 仅在列名、分组和排序字段中被允许
2. 其他非法字符（如 `<`, `>`, `:`, `"`, `\`, `|`, `?` 等）仍然会被拒绝
3. 此修复符合 SQL 标准，`*` 是 SQL 中的合法通配符

## 相关文件

- `src/modules/verifier/verifier.service.ts` - 验证器服务
- `test/verifier-fix.test.ts` - 测试文件
