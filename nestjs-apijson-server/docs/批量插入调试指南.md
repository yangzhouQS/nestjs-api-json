# 批量插入调试指南

## 问题描述

批量插入数据时，只返回第一条记录，而不是所有插入的记录。

## 调试步骤

### 1. 检查日志输出

执行批量插入请求后，查看服务器日志输出：

```bash
curl -X 'POST' \
  'http://localhost:3900/api/apijson/post' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "user[]": [
    {
      "name": "张三",
      "age": 25
    },
    {
      "name": "李四",
      "age": 26
    }
  ]
}'
```

**关键日志信息**：

```
[MySQLExecutorService] 执行 INSERT 查询: user
[MySQLExecutorService] SQL: INSERT INTO `user` (`name`,`age`) VALUES (?, ?), (?, ?)
[MySQLExecutorService] 参数: ["张三", 25, "李四", 26]
[MySQLExecutorService] query.data 类型: object
[MySQLExecutorService] query.data 是否为数组: false
[MySQLExecutorService] query.data 内容: {"name":"张三","age":25}
```

**如果看到 `query.data 是否为数组: false`，说明问题出在解析器或构建器阶段。**

### 2. 检查表名大小写

**问题**：MySQL表名可能区分大小写

```bash
# 查看数据库中的表名
mysql -u root -p
USE your_database;
SHOW TABLES;
```

如果表名是 `User`（大写），但请求中使用 `user[]`（小写），可能导致查询失败。

**解决方案**：

1. **使用正确的表名**：
```json
{
  "User[]": [
    {
      "name": "张三",
      "age": 25
    },
    {
      "name": "李四",
      "age": 26
    }
  ]
}
```

2. **或者修改数据库配置**：在MySQL配置中设置 `lower_case_table_names=1`

### 3. 检查解析器输出

查看解析器是否正确识别为数组：

```typescript
// 在 core-parser.service.ts 的 parseTableQuery 方法中添加日志
if (Array.isArray(tableData)) {
  this.logger.log(`✅ 检测到数组数据: ${tableData.length} 条`);
  return {
    name: tableName,
    operation,
    columns: ['*'],
    where: {},
    joins: [],
    group: [],
    having: {},
    order: [],
    limit: 10,
    offset: 0,
    isArray: true,
    data: tableData,
  };
}
```

### 4. 检查构建器输出

查看构建器是否正确构建批量插入SQL：

```typescript
// 在 mysql-builder.service.ts 的 buildInsertQuery 方法中添加日志
if (Array.isArray(data)) {
  this.logger.log(`✅ 批量插入: ${data.length} 条记录`);
  const columns = Object.keys(data[0]).filter(col => !col.startsWith('@'));
  this.logger.log(`列名: ${columns.join(', ')}`);
  // ...
}
```

### 5. 检查执行器输出

查看执行器是否正确识别批量插入：

```typescript
// 在 mysql-executor.service.ts 的 executeInsert 方法中
this.logger.debug(`query.data 类型: ${typeof query.data}`);
this.logger.debug(`query.data 是否为数组: ${Array.isArray(query.data)}`);
this.logger.debug(`query.data 长度: ${Array.isArray(query.data) ? query.data.length : 'N/A'}`);
```

## 常见问题

### 问题1: query.data 不是数组

**症状**：日志显示 `query.data 是否为数组: false`

**原因**：解析器或构建器没有正确传递数组数据

**解决方案**：检查解析器的 `isArray` 标志是否正确设置

### 问题2: 表名大小写不匹配

**症状**：查询返回空结果或错误

**原因**：数据库表名与请求表名大小写不一致

**解决方案**：使用正确的表名大小写

### 问题3: affectedRows 值不正确

**症状**：只返回部分记录

**原因**：MySQL返回的 `affectedRows` 可能不等于插入的记录数

**解决方案**：使用 `query.data.length` 而不是 `affectedRows`

## 临时解决方案

如果问题无法立即解决，可以使用以下临时方案：

### 方案1: 单条插入

```json
{
  "user": {
    "name": "张三",
    "age": 25
  }
}
```

### 方案2: 使用事务

```json
{
  "@transaction": true,
  "user[]": [
    {
      "name": "张三",
      "age": 25
    },
    {
      "name": "李四",
      "age": 26
    }
  ]
}
```

## 需要的信息

如果问题仍然存在，请提供以下信息：

1. **服务器日志**：完整的日志输出
2. **数据库表结构**：
   ```sql
   DESCRIBE User;
   ```
3. **MySQL版本**：
   ```sql
   SELECT VERSION();
   ```
4. **数据库配置**：`lower_case_table_names` 设置
5. **完整的请求和响应**：包括所有字段

## 下一步

1. 查看服务器日志，确认 `query.data` 是否为数组
2. 检查数据库表名大小写
3. 如果问题仍然存在，提供上述信息以便进一步诊断
