# 数据库重复初始化修复说明

## 问题描述

启动应用时，数据库连接被初始化了三次，导致资源浪费和潜在的问题：

```
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化数据库连接
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化MySQL连接
[Nest] 42028  - 2026/01/02 10:45:15     LOG [DatabaseService] MySQL连接池初始化成功
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化数据库连接
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化MySQL连接
[Nest] 42028  - 2026/01/02 10:45:15     LOG [DatabaseService] MySQL连接池初始化成功
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化数据库连接
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化MySQL连接
[Nest] 42028  - 2026/01/02 10:45:15     LOG [DatabaseService] MySQL连接池初始化成功
```

## 问题原因

在 NestJS 中，如果一个 Service 在多个模块中被声明为 `provider`，每次声明都会创建一个新的实例。`DatabaseService` 在三个模块中被重复声明：

1. **DatabaseModule** - 正确的声明
2. **ExecutorModule** - 错误的重复声明
3. **AdvancedModule** - 错误的重复声明

### 错误的模块配置

#### 1. ExecutorModule（修复前）

```typescript
@Module({
    providers: [
        ExecutorService,
        MySQLExecutorService,
        DatabaseService  // ❌ 错误：重复声明
    ],
    exports: [
        ExecutorService,
        MySQLExecutorService,
    ],
})
```

#### 2. AdvancedModule（修复前）

```typescript
@Module({
    imports: [DatabaseModule],
    controllers: [AdvancedController],
    providers: [AdvancedFeaturesService, DatabaseService],  // ❌ 错误：重复声明
    exports: [AdvancedFeaturesService],
})
```

## 修复方案

### NestJS 依赖注入原则

1. **Service 应该只在其自己的模块中声明为 provider**
2. **其他模块应该通过 imports 导入该模块**
3. **通过 constructor 注入使用 Service**

### 修复 ExecutorModule

```typescript
import {Module} from '@nestjs/common';
import {ExecutorService} from './executor.service';
import {MySQLExecutorService} from './mysql-executor.service';
import {DatabaseModule} from "@/modules/database/database.module";  // ✅ 导入模块

/**
 * 执行器模块
 * 负责执行 SQL 查询并处理结果
 */
@Module({
    imports: [
        DatabaseModule  // ✅ 导入 DatabaseModule
    ],
    providers: [
        ExecutorService,
        MySQLExecutorService
        // ✅ 移除 DatabaseService
    ],
    exports: [
        ExecutorService,
        MySQLExecutorService,
    ],
})
export class ExecutorModule {
}
```

### 修复 AdvancedModule

```typescript
import {Module} from '@nestjs/common';
import {AdvancedFeaturesService} from './advanced-features.service';
import {AdvancedController} from './advanced.controller';
import {DatabaseModule} from '../database/database.module';  // ✅ 导入模块

/**
 * 高级特性模块
 * 提供子查询、聚合函数、事务等高级功能
 */
@Module({
    imports: [DatabaseModule],  // ✅ 导入 DatabaseModule
    controllers: [AdvancedController],
    providers: [AdvancedFeaturesService],  // ✅ 移除 DatabaseService
    exports: [AdvancedFeaturesService],
})
export class AdvancedModule {
}
```

## 修复后的效果

### 启动日志

修复后，数据库只会初始化一次：

```
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化数据库连接
[Nest] 42028  - 2026/01/02 10:45:15   DEBUG [DatabaseService] 初始化MySQL连接
[Nest] 42028  - 2026/01/02 10:45:15     LOG [DatabaseService] MySQL连接池初始化成功
```

### 优势

1. **资源优化** - 只创建一个数据库连接池
2. **性能提升** - 减少初始化开销
3. **避免冲突** - 防止多个连接池之间的状态不一致
4. **符合最佳实践** - 遵循 NestJS 的模块依赖注入模式

## NestJS 模块依赖注入最佳实践

### 1. Service 声明

Service 应该只在其自己的模块中声明：

```typescript
// ✅ 正确
@Module({
  providers: [DatabaseService],
  exports: [DatabaseService],
})
export class DatabaseModule {}
```

### 2. 模块导入

其他模块应该导入该模块：

```typescript
// ✅ 正确
@Module({
  imports: [DatabaseModule],
  providers: [SomeService],
})
export class SomeModule {}
```

### 3. Service 注入

通过 constructor 注入使用：

```typescript
// ✅ 正确
@Injectable()
export class SomeService {
  constructor(
    private readonly databaseService: DatabaseService
  ) {}
}
```

### 4. 避免重复声明

不要在多个模块中重复声明同一个 Service：

```typescript
// ❌ 错误
@Module({
  imports: [DatabaseModule],
  providers: [DatabaseService],  // 不要重复声明
})
export class SomeModule {}
```

## 相关文件

- [`src/modules/database/database.module.ts`](../src/modules/database/database.module.ts) - 数据库模块（正确的声明）
- [`src/modules/executor/executor.module.ts`](../src/modules/executor/executor.module.ts) - 执行器模块（已修复）
- [`src/modules/advanced/advanced.module.ts`](../src/modules/advanced/advanced.module.ts) - 高级特性模块（已修复）

## 注意事项

1. **单一职责** - 每个 Service 应该只在一个模块中声明
2. **依赖注入** - 使用 imports 而不是重复声明 providers
3. **模块导出** - 确保模块导出需要被其他模块使用的 Service
4. **全局模块** - 如果需要在整个应用中使用，可以考虑使用 `@Global()` 装饰器

## 全局模块选项

如果 `DatabaseService` 需要在整个应用中使用，可以将其标记为全局模块：

```typescript
import { Global, Module } from '@nestjs/common';

@Global()  // ✅ 标记为全局模块
@Module({
  providers: [DatabaseService],
  exports: [DatabaseService],
})
export class DatabaseModule {}
```

这样其他模块就不需要导入 `DatabaseModule`，可以直接注入使用：

```typescript
@Module({
  // 不需要 imports: [DatabaseModule]
  providers: [SomeService],
})
export class SomeModule {}
```

## 总结

通过移除重复的 `DatabaseService` 声明，并使用正确的模块导入方式，解决了数据库重复初始化的问题。这符合 NestJS 的最佳实践，提高了应用的性能和可维护性。
