# 数组查询语法分析

## 查询格式

```json
{
  "receive": {
    "id": 1,
    "@column": "id,order_code,order_date,supplier_name,status,created_at"
  },
  "[]": {
    "receive_item": {
      "order_id@": "/receive/id",
      "@column": "id, order_id, material_name, status, created_at"
    }
  }
}
```

## 语法分析

### 1. `[]` 对象的含义

`[]` 是 APIJSON 的特殊语法，用于表示**数组查询**。

- **位置**：作为顶层键，与表名同级
- **作用**：包装需要返回数组的表查询
- **结果**：返回的值是一个数组，而不是单个对象

### 2. 查询结构

这个请求包含两个部分：

1. **主表查询**：`receive` 表
   - 查询单条记录（`id = 1`）
   - 返回单个对象

2. **数组查询**：`[]` 对象中的 `receive_item` 表
   - 查询多条记录（`order_id = receive.id`）
   - 返回数组

## 预期返回结果

### 标准格式

```json
{
  "code": 200,
  "msg": "success",
  "receive": {
    "id": 1,
    "order_code": "ORD001",
    "order_date": "2024-01-01",
    "supplier_name": "供应商A",
    "status": "completed",
    "created_at": "2024-01-01 10:00:00"
  },
  "[]": [
    {
      "receive_item": {
        "id": 1,
        "order_id": 1,
        "material_name": "材料A",
        "status": "pending",
        "created_at": "2024-01-01 10:00:00"
      }
    },
    {
      "receive_item": {
        "id": 2,
        "order_id": 1,
        "material_name": "材料B",
        "status": "pending",
        "created_at": "2024-01-01 10:00:00"
      }
    }
  ]
}
```

### 简化格式（推荐）

更常见的返回格式是直接返回数组，不嵌套在 `receive_item` 对象中：

```json
{
  "code": 200,
  "msg": "success",
  "receive": {
    "id": 1,
    "order_code": "ORD001",
    "order_date": "2024-01-01",
    "supplier_name": "供应商A",
    "status": "completed",
    "created_at": "2024-01-01 10:00:00"
  },
  "receive_item": [
    {
      "id": 1,
      "order_id": 1,
      "material_name": "材料A",
      "status": "pending",
      "created_at": "2024-01-01 10:00:00"
    },
    {
      "id": 2,
      "order_id": 1,
      "material_name": "材料B",
      "status": "pending",
      "created_at": "2024-01-01 10:00:00"
    }
  ]
}
```

## 实现要求

### 1. 解析器处理

解析器需要识别 `[]` 键，并：

1. 将 `[]` 标记为数组查询容器
2. 解析 `[]` 内部的表查询（如 `receive_item`）
3. 标记这些表为数组查询（`isArray = true`）

### 2. 引用解析

对于 `[]` 内部的表：

- 引用路径 `"/receive/id"` 仍然有效
- 需要先执行 `receive` 表查询
- 从 `receive` 结果中提取 `id` 的值
- 使用该值查询 `receive_item` 表

### 3. 结果格式化

执行器需要：

1. 将 `receive` 表的结果作为对象返回
2. 将 `receive_item` 表的结果作为数组返回
3. 如果使用 `[]` 语法，返回格式为 `[]: [数组]`
4. 如果不使用 `[]` 语法，返回格式为 `receive_item: [数组]`

## 对比分析

### 格式 1：不使用 `[]`

**请求：**
```json
{
  "receive": {
    "id": 1
  },
  "receive_item": {
    "order_id@": "/receive/id"
  }
}
```

**返回：**
```json
{
  "receive": { "id": 1, ... },
  "receive_item": [
    { "id": 1, "order_id": 1, ... },
    { "id": 2, "order_id": 1, ... }
  ]
}
```

### 格式 2：使用 `[]`

**请求：**
```json
{
  "receive": {
    "id": 1
  },
  "[]": {
    "receive_item": {
      "order_id@": "/receive/id"
    }
  }
}
```

**返回（标准格式）：**
```json
{
  "receive": { "id": 1, ... },
  "[]": [
    { "receive_item": { "id": 1, "order_id": 1, ... } },
    { "receive_item": { "id": 2, "order_id": 1, ... } }
  ]
}
```

**返回（简化格式）：**
```json
{
  "receive": { "id": 1, ... },
  "receive_item": [
    { "id": 1, "order_id": 1, ... },
    { "id": 2, "order_id": 1, ... }
  ]
}
```

## 推荐实现

根据 APIJSON 的常见实践，**推荐使用简化格式**：

1. 识别 `[]` 键，但返回时直接使用表名作为键
2. 返回的值是数组，而不是嵌套对象
3. 这样更符合 RESTful API 的常见格式

### 实现步骤

1. **修改解析器**：识别 `[]` 键，标记内部表为数组查询
2. **修改执行器**：对数组查询的结果，直接使用表名作为键
3. **保持引用解析**：`[]` 内部的引用仍然需要解析

## 总结

- `[]` 语法用于表示数组查询
- 引用赋值在 `[]` 内部仍然有效
- 返回格式可以是嵌套（`[]: [{receive_item: {...}}]`）或简化（`receive_item: [{...}]`）
- 推荐使用简化格式，更符合常见 API 规范
