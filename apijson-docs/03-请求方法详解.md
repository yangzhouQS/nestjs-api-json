# APIJSONORM 请求方法详解

## 1. 概述

APIJSONORM 支持多种请求方法，每种方法对应不同的数据库操作。通过不同的请求方法，可以实现查询、新增、更新、删除等操作。

## 2. 请求方法列表

| 方法 | 说明 | HTTP 方法 | 是否需要验证 |
|------|------|-----------|-------------|
| GET | 查询单个对象 | GET | 可选 |
| GETS | 查询多个对象 | GET | 可选 |
| HEAD | 查询总数 | HEAD | 可选 |
| HEADS | 查询多个总数 | HEAD | 可选 |
| POST | 新增数据 | POST | 必须 |
| PUT | 更新数据 | PUT | 必须 |
| DELETE | 删除数据 | DELETE | 必须 |
| CRUD | 混合操作 | POST | 必须 |

## 3. GET 方法

### 3.1 方法说明

GET 方法用于查询单个对象，返回符合条件的第一条记录。

### 3.2 请求格式

```json
{
  "Table": {
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 3.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "Table": {
    "id": 1,
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 3.4 使用示例

#### 示例 1：根据 ID 查询

```json
// 请求
{
  "User": {
    "id": 1
  }
}

// 生成的 SQL
SELECT * FROM User WHERE id = 1 LIMIT 1

// 响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  }
}
```

#### 示例 2：多条件查询

```json
// 请求
{
  "User": {
    "name": "张三",
    "age>": 18
  }
}

// 生成的 SQL
SELECT * FROM User WHERE name = '张三' AND age > 18 LIMIT 1

// 响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  }
}
```

#### 示例 3：指定查询字段

```json
// 请求
{
  "User": {
    "id": 1,
    "@column": "id,name,age"
  }
}

// 生成的 SQL
SELECT id, name, age FROM User WHERE id = 1 LIMIT 1

// 响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  }
}
```

#### 示例 4：排序

```json
// 请求
{
  "User": {
    "age>": 18,
    "@order": "age-"
  }
}

// 生成的 SQL
SELECT * FROM User WHERE age > 18 ORDER BY age DESC LIMIT 1

// 响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 30
  }
}
```

### 3.5 特殊字段

| 字段 | 说明 | 示例 |
|------|------|------|
| @column | 指定查询字段 | `"@column": "id,name,age"` |
| @order | 指定排序 | `"@order": "age-,name+"` |
| @group | 指定分组 | `"@group": "name"` |
| @having | 指定分组过滤 | `"@having": "count(*)>1"` |
| @role | 指定角色 | `"@role": "ADMIN"` |

## 4. GETS 方法

### 4.1 方法说明

GETS 方法用于查询多个对象，返回符合条件的记录列表。

### 4.2 请求格式

```json
{
  "Table[]": {
    "count": 10,
    "page": 0,
    "Table": {
      "field1": "value1",
      "field2": "value2"
    }
  }
}
```

### 4.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "Table[]": [
    {
      "id": 1,
      "field1": "value1",
      "field2": "value2"
    },
    {
      "id": 2,
      "field1": "value3",
      "field2": "value4"
    }
  ],
  "count": 2
}
```

### 4.4 使用示例

#### 示例 1：分页查询

```json
// 请求
{
  "User[]": {
    "count": 10,
    "page": 0,
    "User": {
      "age>": 18
    }
  }
}

// 生成的 SQL
SELECT * FROM User WHERE age > 18 LIMIT 10 OFFSET 0

// 响应
{
  "code": 200,
  "msg": "success",
  "User[]": [
    {
      "id": 1,
      "name": "张三",
      "age": 25
    },
    {
      "id": 2,
      "name": "李四",
      "age": 30
    }
  ],
  "count": 2
}
```

#### 示例 2：查询总数

```json
// 请求
{
  "User[]": {
    "query": 1,
    "User": {
      "age>": 18
    }
  }
}

// 生成的 SQL
SELECT COUNT(*) FROM User WHERE age > 18

// 响应
{
  "code": 200,
  "msg": "success",
  "total": 100
}
```

#### 示例 3：查询数据和总数

```json
// 请求
{
  "User[]": {
    "query": 2,
    "count": 10,
    "page": 0,
    "User": {
      "age>": 18
    }
  }
}

// 生成的 SQL
SELECT COUNT(*) FROM User WHERE age > 18
SELECT * FROM User WHERE age > 18 LIMIT 10 OFFSET 0

// 响应
{
  "code": 200,
  "msg": "success",
  "User[]": [
    {
      "id": 1,
      "name": "张三",
      "age": 25
    }
  ],
  "total": 100,
  "count": 1,
  "info": {
    "total": 100,
    "count": 10,
    "page": 1,
    "max": 10,
    "more": true,
    "first": true,
    "last": false
  }
}
```

### 4.5 特殊字段

| 字段 | 说明 | 可选值 | 默认值 |
|------|------|--------|--------|
| count | 每页数量 | 0-100 | 10 |
| page | 页码 | 0-100 | 0 |
| query | 查询类型 | 0-只查数据, 1-只查总数, 2-查数据和总数 | 0 |
| @column | 指定查询字段 | - | * |
| @order | 指定排序 | - | - |
| @group | 指定分组 | - | - |
| @having | 指定分组过滤 | - | - |

## 5. HEAD 方法

### 5.1 方法说明

HEAD 方法用于查询总数，返回符合条件的记录数量。

### 5.2 请求格式

```json
{
  "Table": {
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 5.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "count": 100
}
```

### 5.4 使用示例

#### 示例 1：查询总数

```json
// 请求
{
  "User": {
    "age>": 18
  }
}

// 生成的 SQL
SELECT COUNT(*) FROM User WHERE age > 18

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 100
}
```

#### 示例 2：聚合查询

```json
// 请求
{
  "User": {
    "@column": "COUNT(*):count",
    "age>": 18
  }
}

// 生成的 SQL
SELECT COUNT(*) AS count FROM User WHERE age > 18

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 100
}
```

## 6. POST 方法

### 6.1 方法说明

POST 方法用于新增数据，返回新增的记录。

### 6.2 请求格式

```json
{
  "Table": {
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 6.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "id": 1,
  "Table": {
    "id": 1,
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 6.4 使用示例

#### 示例 1：新增单条记录

```json
// 请求
{
  "User": {
    "name": "张三",
    "age": 25
  }
}

// 生成的 SQL
INSERT INTO User (name, age) VALUES ('张三', 25)

// 响应
{
  "code": 200,
  "msg": "success",
  "id": 1,
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  }
}
```

#### 示例 2：批量新增

```json
// 请求
{
  "User[]": [
    {
      "name": "张三",
      "age": 25
    },
    {
      "name": "李四",
      "age": 30
    }
  ]
}

// 生成的 SQL
INSERT INTO User (name, age) VALUES ('张三', 25), ('李四', 30)

// 响应
{
  "code": 200,
  "msg": "success",
  "id": 1,
  "User[]": [
    {
      "id": 1,
      "name": "张三",
      "age": 25
    },
    {
      "id": 2,
      "name": "李四",
      "age": 30
    }
  ]
}
```

### 6.5 注意事项

1. POST 方法必须通过验证
2. 需要登录才能执行
3. 需要相应的权限
4. 字段值不能为 null（除非允许）

## 7. PUT 方法

### 7.1 方法说明

PUT 方法用于更新数据，返回更新的记录。

### 7.2 请求格式

```json
{
  "Table": {
    "id": 1,
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 7.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "id": 1,
  "count": 1,
  "Table": {
    "id": 1,
    "field1": "value1",
    "field2": "value2"
  }
}
```

### 7.4 使用示例

#### 示例 1：更新单条记录

```json
// 请求
{
  "User": {
    "id": 1,
    "name": "李四",
    "age": 30
  }
}

// 生成的 SQL
UPDATE User SET name = '李四', age = 30 WHERE id = 1

// 响应
{
  "code": 200,
  "msg": "success",
  "id": 1,
  "count": 1,
  "User": {
    "id": 1,
    "name": "李四",
    "age": 30
  }
}
```

#### 示例 2：批量更新

```json
// 请求
{
  "User[]": [
    {
      "id": 1,
      "name": "张三"
    },
    {
      "id": 2,
      "name": "李四"
    }
  ]
}

// 生成的 SQL
UPDATE User SET name = '张三' WHERE id = 1
UPDATE User SET name = '李四' WHERE id = 2

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 2,
  "User[]": [
    {
      "id": 1,
      "name": "张三"
    },
    {
      "id": 2,
      "name": "李四"
    }
  ]
}
```

#### 示例 3：条件更新

```json
// 请求
{
  "User": {
    "age>": 18,
    "name": "成年人"
  }
}

// 生成的 SQL
UPDATE User SET name = '成年人' WHERE age > 18

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 100
}
```

### 7.5 注意事项

1. PUT 方法必须通过验证
2. 需要登录才能执行
3. 需要相应的权限
4. 必须提供 WHERE 条件（否则会更新所有记录）

## 8. DELETE 方法

### 8.1 方法说明

DELETE 方法用于删除数据，返回删除的记录数量。

### 8.2 请求格式

```json
{
  "Table": {
    "id": 1
  }
}
```

### 8.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "count": 1
}
```

### 8.4 使用示例

#### 示例 1：删除单条记录

```json
// 请求
{
  "User": {
    "id": 1
  }
}

// 生成的 SQL
DELETE FROM User WHERE id = 1

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 1
}
```

#### 示例 2：条件删除

```json
// 请求
{
  "User": {
    "age<": 18
  }
}

// 生成的 SQL
DELETE FROM User WHERE age < 18

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 10
}
```

#### 示例 3：批量删除

```json
// 请求
{
  "User": {
    "id{}": [1, 2, 3]
  }
}

// 生成的 SQL
DELETE FROM User WHERE id IN (1, 2, 3)

// 响应
{
  "code": 200,
  "msg": "success",
  "count": 3
}
```

### 8.5 注意事项

1. DELETE 方法必须通过验证
2. 需要登录才能执行
3. 需要相应的权限
4. 必须提供 WHERE 条件（否则会删除所有记录）
5. 删除操作不可恢复，请谨慎使用

## 9. CRUD 方法

### 9.1 方法说明

CRUD 方法用于混合操作，可以在一个请求中执行多个不同的操作。

### 9.2 请求格式

```json
{
  "User": {
    "@method": "POST",
    "name": "张三",
    "age": 25
  },
  "Moment": {
    "@method": "PUT",
    "id": 1,
    "content": "更新内容"
  },
  "Comment": {
    "@method": "DELETE",
    "id": 1
  }
}
```

### 9.3 响应格式

```json
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  },
  "Moment": {
    "id": 1,
    "content": "更新内容"
  },
  "Comment": {
    "count": 1
  }
}
```

### 9.4 使用示例

#### 示例 1：混合操作

```json
// 请求
{
  "User": {
    "@method": "POST",
    "name": "张三",
    "age": 25
  },
  "Moment": {
    "@method": "PUT",
    "id": 1,
    "content": "更新内容"
  }
}

// 生成的 SQL
INSERT INTO User (name, age) VALUES ('张三', 25)
UPDATE Moment SET content = '更新内容' WHERE id = 1

// 响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三",
    "age": 25
  },
  "Moment": {
    "id": 1,
    "content": "更新内容"
  }
}
```

### 9.5 注意事项

1. CRUD 方法必须通过验证
2. 需要登录才能执行
3. 需要相应的权限
4. 所有操作在一个事务中执行
5. 如果任一操作失败，所有操作都会回滚

## 10. 条件运算符

### 10.1 比较运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| = | 等于 | `"id": 1` |
| != | 不等于 | `"id!=": 1` |
| > | 大于 | `"age>": 18` |
| < | 小于 | `"age<": 60` |
| >= | 大于等于 | `"age>=": 18` |
| <= | 小于等于 | `"age<=": 60` |
| <> | 不等于 | `"id<>": 1` |

### 10.2 逻辑运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| \| | 或 | `"id\|": 1` |
| & | 与 | `"id&": 1` |
| ! | 非 | `"id!": 1` |

### 10.3 模糊匹配

| 运算符 | 说明 | 示例 |
|--------|------|------|
| ~ | 模糊匹配 | `"name~": "张"` |
| !~ | 不模糊匹配 | `"name!~": "张"` |

### 10.4 范围运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| {} | IN | `"id{}": [1, 2, 3]` |
| !{} | NOT IN | `"id!{}": [1, 2, 3]` |
| >< | BETWEEN | `"age><": [18, 60]` |
| !>< | NOT BETWEEN | `"age!><": [18, 60]` |

### 10.5 数组运算符

| 运算符 | 说明 | 示例 |
|--------|------|------|
| <> | 包含 | `"userId<>": 1` |
| !<> | 不包含 | `"userId!<>": 1` |

## 11. 特殊字段

### 11.1 全局字段

| 字段 | 说明 | 位置 | 示例 |
|------|------|------|------|
| tag | 请求标签 | 最外层 | `"tag": "User"` |
| version | 请求版本 | 最外层 | `"version": 1` |
| format | 格式化响应 | 最外层 | `"format": true` |
| role | 用户角色 | 最外层或对象内 | `"role": "ADMIN"` |
| database | 数据库名 | 最外层或对象内 | `"database": "test"` |
| schema | 模式名 | 最外层或对象内 | `"schema": "public"` |
| explain | 执行计划 | 对象内 | `"explain": true` |

### 11.2 查询字段

| 字段 | 说明 | 位置 | 示例 |
|------|------|------|------|
| @column | 查询字段 | 对象内 | `"@column": "id,name,age"` |
| @order | 排序 | 对象内 | `"@order": "age-,name+"` |
| @group | 分组 | 对象内 | `"@group": "name"` |
| @having | 分组过滤 | 对象内 | `"@having": "count(*)>1"` |
| @combine | 组合查询 | 对象内 | `"@combine": "id,name"` |

### 11.3 数组字段

| 字段 | 说明 | 位置 | 示例 |
|------|------|------|------|
| count | 每页数量 | 数组对象 | `"count": 10` |
| page | 页码 | 数组对象 | `"page": 0` |
| query | 查询类型 | 数组对象 | `"query": 2` |
| join | 关联查询 | 数组对象 | `"join": "@/User/id@"` |

## 12. 引用赋值

### 12.1 基本语法

引用赋值允许在一个请求中引用另一个字段的值。

```json
{
  "User": {
    "id": 1
  },
  "Moment": {
    "userId@": "/User/id"
  }
}
```

### 12.2 使用示例

#### 示例 1：引用单个值

```json
// 请求
{
  "User": {
    "id": 1
  },
  "Moment": {
    "userId@": "/User/id"
  }
}

// 生成的 SQL
SELECT * FROM User WHERE id = 1 LIMIT 1
SELECT * FROM Moment WHERE userId = 1
```

#### 示例 2：引用数组值

```json
// 请求
{
  "User[]": {
    "count": 10,
    "User": {
      "age>": 18
    }
  },
  "Moment-userId[]": {
    "Moment": {
      "userId{}@": "/User[]/id"
    }
  }
}

// 生成的 SQL
SELECT * FROM User WHERE age > 18 LIMIT 10
SELECT * FROM Moment WHERE userId IN (1, 2, 3, ...)
```

## 13. 总结

APIJSONORM 提供了丰富的请求方法，可以满足各种数据库操作需求：

1. **GET**：查询单个对象
2. **GETS**：查询多个对象
3. **HEAD**：查询总数
4. **HEADS**：查询多个总数
5. **POST**：新增数据
6. **PUT**：更新数据
7. **DELETE**：删除数据
8. **CRUD**：混合操作

通过合理使用这些方法和各种运算符，可以实现复杂的数据库操作，而无需编写 SQL 语句。
