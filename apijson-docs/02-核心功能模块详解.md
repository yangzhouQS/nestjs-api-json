# APIJSONORM 核心功能模块详解

## 1. Parser 解析模块

### 1.1 模块概述

Parser 模块是 APIJSONORM 的核心解析层，负责解析客户端发送的 JSON 请求，并将其转换为内部可处理的数据结构。Parser 模块是整个框架的入口，协调其他模块完成请求处理。

### 1.2 AbstractParser 核心类

`AbstractParser` 是解析模块的核心抽象类，提供了请求解析的主要功能。

#### 1.2.1 主要职责

1. **请求解析**：解析 JSON 格式的请求
2. **请求验证**：验证请求的格式和内容
3. **权限控制**：验证用户的操作权限
4. **SQL 生成协调**：协调 SQLConfig 模块生成 SQL
5. **SQL 执行协调**：协调 SQLExecutor 模块执行 SQL
6. **结果封装**：封装执行结果并返回给客户端
7. **事务管理**：管理数据库事务

#### 1.2.2 核心方法

##### parseResponse(M request)

```java
public M parseResponse(M request)
```

**功能**：解析 JSON 请求并返回响应结果

**处理流程**：
1. 提取全局参数（format, version, tag, role, database, schema 等）
2. 执行登录验证（如果需要）
3. 执行内容验证（如果需要）
4. 解析请求对象
5. 执行 SQL 语句
6. 封装结果并返回

**示例**：
```java
// 输入请求
{
  "User": {
    "id": 1,
    "name": "张三"
  }
}

// 输出响应
{
  "code": 200,
  "msg": "success",
  "User": {
    "id": 1,
    "name": "张三"
  }
}
```

##### onObjectParse(M request, String parentPath, String name, SQLConfig arrayConfig, boolean isSubquery, M cache)

```java
public M onObjectParse(M request, String parentPath, String name, 
                       SQLConfig arrayConfig, boolean isSubquery, M cache)
```

**功能**：解析对象类型的请求

**参数说明**：
- `request`：请求对象
- `parentPath`：父路径
- `name`：对象名称
- `arrayConfig`：数组配置（如果是数组项）
- `isSubquery`：是否为子查询
- `cache`：缓存数据

**处理流程**：
1. 检查查询深度是否超限
2. 创建 ObjectParser
3. 设置请求方法
4. 解析对象
5. 执行 SQL
6. 返回结果

##### onArrayParse(M request, String parentPath, String name, boolean isSubquery, L cache)

```java
public L onArrayParse(M request, String parentPath, String name, 
                      boolean isSubquery, L cache)
```

**功能**：解析数组类型的请求

**参数说明**：
- `request`：请求对象
- `parentPath`：父路径
- `name`：数组名称
- `isSubquery`：是否为子查询
- `cache`：缓存数据

**处理流程**：
1. 验证请求方法（只支持 GET、GETS）
2. 解析分页参数（count, page）
3. 解析 JOIN 配置
4. 循环解析数组项
5. 返回结果列表

##### onJoinParse(Object join, M request)

```java
private List<Join> onJoinParse(Object join, M request)
```

**功能**：解析 JOIN 配置

**支持的 JOIN 类型**：
- `@`：APP JOIN（应用级 JOIN）
- `&`：INNER JOIN
- `|`：FULL JOIN
- `<`：LEFT JOIN
- `>`：RIGHT JOIN
- `!`：OUTER JOIN
- `^`：SIDE JOIN
- `(`：ANTI JOIN
- `)`：FOREIGN JOIN
- `~`：ASOF JOIN

**示例**：
```java
// 请求
{
  "Moment": {
    "userId": 82001
  },
  "join": "@/User/id@,&/Comment/toId@"
}

// 生成的 SQL
SELECT Moment.*, User.*, Comment.*
FROM Moment
INNER JOIN User ON User.id = Moment.userId
INNER JOIN Comment ON Comment.toId = Moment.id
```

### 1.3 AbstractObjectParser 核心类

`AbstractObjectParser` 负责解析对象类型的请求。

#### 1.3.1 主要职责

1. 对象解析
2. 字段提取
3. 条件解析
4. 引用解析
5. 函数解析

#### 1.3.2 核心方法

##### parse(String name, boolean isReuse)

```java
public ObjectParser parse(String name, boolean isReuse)
```

**功能**：解析对象

**处理流程**：
1. 解析表名和别名
2. 解析请求方法
3. 解析字段列表
4. 解析 WHERE 条件
5. 解析 GROUP BY
6. 解析 HAVING
7. 解析 ORDER BY
8. 解析分页参数
9. 创建 SQLConfig
10. 返回解析结果

### 1.4 AbstractFunctionParser 核心类

`AbstractFunctionParser` 负责解析和执行远程函数调用。

#### 1.4.1 主要职责

1. 函数解析
2. 参数提取
3. 函数调用
4. 脚本执行

#### 1.4.2 核心方法

##### invoke(String function, M current)

```java
public Object invoke(String function, M current) throws Exception
```

**功能**：调用远程函数

**参数说明**：
- `function`：函数调用字符串，格式为 `function(arg1, arg2, ...)`
- `current`：当前对象

**示例**：
```java
// 请求
{
  "User": {
    "id": "isContain(id[], 1)"
  }
}

// 函数定义
public boolean isContain(Map<String, Object> request, String key, int value) {
    List<Integer> list = JSON.parseArray(request.get(key), Integer.class);
    return list.contains(value);
}
```

##### parseFunction(String function, Map<String, Object> request, boolean isSQLFunction)

```java
public static FunctionBean parseFunction(String function, Map<String, Object> request, 
                                         boolean isSQLFunction)
```

**功能**：解析函数调用字符串

**返回值**：`FunctionBean` 对象，包含函数名、参数类型、参数值等信息

### 1.5 请求处理流程

```
客户端请求
    │
    ▼
parseResponse() - 解析响应
    │
    ├─► 提取全局参数
    │   ├─ format
    │   ├─ version
    │   ├─ tag
    │   ├─ role
    │   ├─ database
    │   ├─ schema
    │   └─ explain
    │
    ├─► 登录验证
    │   └─ onVerifyLogin()
    │
    ├─► 内容验证
    │   └─ onVerifyContent()
    │
    ├─► 解析请求对象
    │   │
    │   ├─► 对象类型
    │   │   └─ onObjectParse()
    │   │       ├─ 创建 ObjectParser
    │   │       ├─ 解析对象
    │   │       ├─ 创建 SQLConfig
    │   │       └─ 执行 SQL
    │   │
    │   └─► 数组类型
    │       └─ onArrayParse()
    │           ├─ 解析分页参数
    │           ├─ 解析 JOIN 配置
    │           ├─ 循环解析数组项
    │           └─ 返回结果列表
    │
    ├─► 执行 SQL
    │   └─ executeSQL()
    │
    └─► 封装结果
        └─ extendSuccessResult()
```

## 2. SQLConfig SQL 生成模块

### 2.1 模块概述

SQLConfig 模块负责根据解析后的 JSON 请求生成对应的 SQL 语句。该模块是 APIJSONORM 的核心，实现了从 JSON 到 SQL 的转换。

### 2.2 AbstractSQLConfig 核心类

`AbstractSQLConfig` 是 SQL 生成模块的核心抽象类，提供了 SQL 生成的主要功能。

#### 2.2.1 主要职责

1. **SQL 语句生成**：根据请求生成 SELECT、INSERT、UPDATE、DELETE 语句
2. **数据库适配**：适配不同数据库的 SQL 语法差异
3. **WHERE 条件生成**：生成复杂的 WHERE 条件
4. **JOIN 语句生成**：生成各种类型的 JOIN 语句
5. **参数绑定**：生成 Prepared Statement 参数
6. **子查询处理**：处理子查询

#### 2.2.2 支持的数据库

- MySQL
- PostgreSQL
- Oracle
- SQL Server
- MongoDB
- ClickHouse
- TiDB

#### 2.2.3 核心方法

##### getSQL(boolean prepared)

```java
public String getSQL(boolean prepared)
```

**功能**：生成 SQL 语句

**参数说明**：
- `prepared`：是否生成 Prepared Statement 格式（使用 ? 占位符）

**返回值**：生成的 SQL 语句字符串

**示例**：
```java
// JSON 请求
{
  "User": {
    "id": 1,
    "name": "张三"
  }
}

// 生成的 SQL（prepared = false）
SELECT id, name FROM User WHERE id = 1 AND name = '张三'

// 生成的 SQL（prepared = true）
SELECT id, name FROM User WHERE id = ? AND name = ?
```

##### getSQL(boolean prepared, boolean withSQL)

```java
public String getSQL(boolean prepared, boolean withSQL)
```

**功能**：生成 SQL 语句（带子查询）

**参数说明**：
- `prepared`：是否生成 Prepared Statement 格式
- `withSQL`：是否包含子查询的完整 SQL

##### getWhereString(boolean prepared)

```java
public String getWhereString(boolean prepared)
```

**功能**：生成 WHERE 条件字符串

**支持的运算符**：
- `=`：等于
- `!=`：不等于
- `>`：大于
- `<`：小于
- `>=`：大于等于
- `<=`：小于等于
- `<>`：不等于
- `!<>`：包含
- `><`：不包含
- `~`：模糊匹配
- `!~`：不模糊匹配
- `in`：IN
- `!in`：NOT IN
- `between`：BETWEEN
- `!between`：NOT BETWEEN

**示例**：
```java
// JSON 请求
{
  "User": {
    "id": 1,
    "age>": 18,
    "name~": "张",
    "id{}": [1, 2, 3]
  }
}

// 生成的 WHERE 条件
WHERE id = 1 AND age > 18 AND name LIKE '%张%' AND id IN (1, 2, 3)
```

##### getJoinString(boolean prepared)

```java
public String getJoinString(boolean prepared)
```

**功能**：生成 JOIN 语句字符串

**支持的 JOIN 类型**：
- `@`：APP JOIN（应用级 JOIN）
- `&`：INNER JOIN
- `|`：FULL JOIN
- `<`：LEFT JOIN
- `>`：RIGHT JOIN
- `!`：OUTER JOIN
- `^`：SIDE JOIN
- `(`：ANTI JOIN
- `)`：FOREIGN JOIN
- `~`：ASOF JOIN

**示例**：
```java
// JSON 请求
{
  "Moment": {
    "userId": 82001
  },
  "join": "@/User/id@,&/Comment/toId@"
}

// 生成的 JOIN 语句
INNER JOIN User ON User.id = Moment.userId
INNER JOIN Comment ON Comment.toId = Moment.id
```

##### getGroupString()

```java
public String getGroupString()
```

**功能**：生成 GROUP BY 语句字符串

##### getHavingString(boolean prepared)

```java
public String getHavingString(boolean prepared)
```

**功能**：生成 HAVING 语句字符串

##### getOrderString()

```java
public String getOrderString()
```

**功能**：生成 ORDER BY 语句字符串

**支持的排序方式**：
- `+`：升序（ASC）
- `-`：降序（DESC）

**示例**：
```java
// JSON 请求
{
  "User": {
    "@order": "id-,name+"
  }
}

// 生成的 ORDER BY 语句
ORDER BY id DESC, name ASC
```

### 2.3 数据库适配

#### 2.3.1 MySQL 适配

**特点**：
- 支持 LIMIT 分页
- 支持 ` 反引号引用表名和列名
- 支持 `` ` `` 包裹字段名

**示例**：
```sql
SELECT `id`, `name` FROM `User` WHERE `id` = 1 LIMIT 10 OFFSET 0
```

#### 2.3.2 PostgreSQL 适配

**特点**：
- 支持 LIMIT/OFFSET 分页
- 支持 `"` 双引号引用表名和列名
- 支持 JSON 类型

**示例**：
```sql
SELECT "id", "name" FROM "User" WHERE "id" = 1 LIMIT 10 OFFSET 0
```

#### 2.3.3 Oracle 适配

**特点**：
- 使用 ROWNUM 分页
- 支持 `"` 双引号引用表名和列名
- 支持 SEQUENCE

**示例**：
```sql
SELECT "id", "name" FROM "User" WHERE "id" = 1 AND ROWNUM <= 10
```

#### 2.3.4 SQL Server 适配

**特点**：
- 使用 TOP 分页
- 支持 `[]` 方括号引用表名和列名
- 支持 OFFSET FETCH

**示例**：
```sql
SELECT TOP 10 [id], [name] FROM [User] WHERE [id] = 1
```

#### 2.3.5 MongoDB 适配

**特点**：
- 使用 MongoDB 查询语法
- 支持 JSON 文档
- 支持聚合管道

**示例**：
```javascript
db.User.find({
  "id": 1,
  "name": "张三"
}).limit(10)
```

### 2.4 SQL 生成流程

```
JSON 请求
    │
    ▼
解析请求
    │
    ├─► 提取表名
    │
    ├─► 提取字段列表
    │
    ├─► 提取 WHERE 条件
    │   ├─ 简单条件
    │   ├─ 复杂条件
    │   └─ 引用条件
    │
    ├─► 提取 JOIN 配置
    │   ├─ JOIN 类型
    │   ├─ JOIN 表
    │   └─ JOIN 条件
    │
    ├─► 提取 GROUP BY
    │
    ├─► 提取 HAVING
    │
    ├─► 提取 ORDER BY
    │
    └─► 提取分页参数
        │
        ▼
生成 SQL 语句
    │
    ├─► SELECT 语句
    │   ├─ SELECT 子句
    │   ├─ FROM 子句
    │   ├─ JOIN 子句
    │   ├─ WHERE 子句
    │   ├─ GROUP BY 子句
    │   ├─ HAVING 子句
    │   ├─ ORDER BY 子句
    │   └─ LIMIT 子句
    │
    ├─► INSERT 语句
    │
    ├─► UPDATE 语句
    │
    └─► DELETE 语句
        │
        ▼
返回 SQL 语句
```

## 3. SQLExecutor SQL 执行模块

### 3.1 模块概述

SQLExecutor 模块负责执行生成的 SQL 语句，并处理执行结果。该模块是 APIJSONORM 与数据库交互的桥梁。

### 3.2 AbstractSQLExecutor 核心类

`AbstractSQLExecutor` 是 SQL 执行模块的核心抽象类，提供了 SQL 执行的主要功能。

#### 3.2.1 主要职责

1. **SQL 执行**：执行 SQL 语句
2. **结果处理**：处理查询结果集
3. **类型转换**：将数据库类型转换为 Java 类型
4. **缓存管理**：管理 SQL 结果缓存
5. **事务管理**：管理数据库事务
6. **连接管理**：管理数据库连接

#### 3.2.2 核心方法

##### execute(SQLConfig config, boolean isSubquery)

```java
public M execute(SQLConfig config, boolean isSubquery) throws Exception
```

**功能**：执行 SQL 语句

**参数说明**：
- `config`：SQL 配置对象
- `isSubquery`：是否为子查询

**返回值**：执行结果 Map

**处理流程**：
1. 获取数据库连接
2. 生成 SQL 语句
3. 执行 SQL 语句
4. 处理结果集
5. 关闭连接
6. 返回结果

##### executeQuery(String sql, List<Object> values)

```java
public List<Map<String, Object>> executeQuery(String sql, List<Object> values)
```

**功能**：执行查询语句

**参数说明**：
- `sql`：SQL 语句
- `values`：参数值列表

**返回值**：查询结果列表

##### executeUpdate(String sql, List<Object> values)

```java
public int executeUpdate(String sql, List<Object> values)
```

**功能**：执行更新语句

**参数说明**：
- `sql`：SQL 语句
- `values`：参数值列表

**返回值**：影响的行数

### 3.3 缓存机制

#### 3.3.1 缓存策略

SQLExecutor 支持以下缓存策略：

1. **SQL 缓存**：缓存生成的 SQL 语句
2. **结果缓存**：缓存查询结果
3. **配置缓存**：缓存 SQLConfig 对象

#### 3.3.2 缓存配置

```java
// 启用缓存
public static boolean ENABLE_CACHE = true;

// 缓存过期时间（秒）
public static int CACHE_EXPIRE_TIME = 60;

// 最大缓存数量
public static int MAX_CACHE_SIZE = 1000;
```

### 3.4 事务管理

#### 3.4.1 事务隔离级别

```java
// 默认事务隔离级别
public static int DEFAULT_TRANSACTION_ISOLATION = Connection.TRANSACTION_REPEATABLE_READ;

// 支持的事务隔离级别
// Connection.TRANSACTION_NONE
// Connection.TRANSACTION_READ_UNCOMMITTED
// Connection.TRANSACTION_READ_COMMITTED
// Connection.TRANSACTION_REPEATABLE_READ
// Connection.TRANSACTION_SERIALIZABLE
```

#### 3.4.2 事务方法

```java
// 开始事务
public void begin(int transactionIsolation)

// 提交事务
public void commit()

// 回滚事务
public void rollback()

// 回滚到保存点
public void rollback(Savepoint savepoint)
```

### 3.5 SQL 执行流程

```
SQLConfig 对象
    │
    ▼
execute()
    │
    ├─► 获取数据库连接
    │   └─ getConnection()
    │
    ├─► 生成 SQL 语句
    │   └─ config.getSQL()
    │
    ├─► 执行 SQL 语句
    │   │
    │   ├─► 查询语句
    │   │   └─ executeQuery()
    │   │       ├─ 创建 PreparedStatement
    │   │       ├─ 设置参数
    │   │       ├─ 执行查询
    │   │       └─ 处理结果集
    │   │
    │   ├─► 更新语句
    │   │   └─ executeUpdate()
    │   │       ├─ 创建 PreparedStatement
    │   │       ├─ 设置参数
    │   │       ├─ 执行更新
    │   │       └─ 返回影响行数
    │   │
    │   └─► 批量操作
    │       └─ executeBatch()
    │
    ├─► 处理结果
    │   ├─ 类型转换
    │   ├─ 结果封装
    │   └─ 缓存结果
    │
    ├─► 关闭连接
    │   └─ closeConnection()
    │
    └─► 返回结果
```

## 4. Verifier 验证模块

### 4.1 模块概述

Verifier 模块负责验证请求的权限和内容，确保请求的安全性和合法性。

### 4.2 AbstractVerifier 核心类

`AbstractVerifier` 是验证模块的核心抽象类，提供了验证的主要功能。

#### 4.2.1 主要职责

1. **登录验证**：验证用户是否已登录
2. **角色验证**：验证用户角色是否有权限执行操作
3. **内容验证**：验证请求内容是否符合要求
4. **结构验证**：验证请求结构是否合法

#### 4.2.2 角色类型

```java
// 未知用户
public static final String UNKNOWN = "UNKNOWN";

// 已登录用户
public static final String LOGIN = "LOGIN";

// 联系人
public static final String CONTACT = "CONTACT";

// 好友
public static final String CIRCLE = "CIRCLE";

// 所有者
public static final String OWNER = "OWNER";

// 管理员
public static final String ADMIN = "ADMIN";
```

#### 4.2.3 核心方法

##### verifyLogin()

```java
public void verifyLogin() throws Exception
```

**功能**：验证用户是否已登录

**处理流程**：
1. 检查 Visitor 是否存在
2. 检查 Visitor.getId() 是否为空
3. 如果未登录，抛出 NotLoggedInException

##### verifyAccess(SQLConfig config)

```java
public void verifyAccess(SQLConfig config) throws Exception
```

**功能**：验证访问权限

**参数说明**：
- `config`：SQL 配置对象

**处理流程**：
1. 获取用户角色
2. 检查角色是否有权限访问该表
3. 检查角色是否有权限执行该操作
4. 如果无权限，抛出 IllegalAccessException

##### verifyRequest(RequestMethod method, String name, M target, M request, 
                   int maxUpdateCount, String database, String schema)

```java
public M verifyRequest(RequestMethod method, String name, M target, M request, 
                      int maxUpdateCount, String database, String schema)
```

**功能**：验证请求内容

**参数说明**：
- `method`：请求方法
- `name`：表名
- `target`：目标结构
- `request`：请求对象
- `maxUpdateCount`：最大更新数量
- `database`：数据库名
- `schema`：模式名

**返回值**：验证后的请求对象

### 4.3 验证流程

```
请求对象
    │
    ▼
verifyLogin()
    │
    ├─► 检查 Visitor
    │   └─ visitor != null
    │
    ├─► 检查用户 ID
    │   └─ visitor.getId() != null
    │
    └─► 返回验证结果
        │
        ▼
verifyAccess()
    │
    ├─► 获取用户角色
    │   └─ getRole()
    │
    ├─► 检查表访问权限
    │   └─ checkTableAccess()
    │
    ├─► 检查操作权限
    │   └─ checkOperationAccess()
    │
    └─► 返回验证结果
        │
        ▼
verifyRequest()
    │
    ├─► 检查请求结构
    │   └─ checkRequestStructure()
    │
    ├─► 检查字段权限
    │   └─ checkFieldAccess()
    │
    ├─► 检查数据范围
    │   └─ checkDataRange()
    │
    └─► 返回验证结果
```

## 5. JSON 处理模块

### 5.1 模块概述

JSON 处理模块提供了 JSON 序列化和反序列化的功能，是 APIJSONORM 的基础工具模块。

### 5.2 JSON 核心类

`JSON` 是 JSON 工具类，提供了 JSON 操作的静态方法。

#### 5.2.1 主要方法

##### toJSONString(Object obj)

```java
public static String toJSONString(Object obj)
```

**功能**：将对象转换为 JSON 字符串

##### parseObject(Object json)

```java
public static <M extends Map<String, Object>> M parseObject(Object json)
```

**功能**：将 JSON 字符串解析为 Map 对象

##### parseArray(Object json)

```java
public static <L extends List<Object>> L parseArray(Object json)
```

**功能**：将 JSON 字符串解析为 List 对象

### 5.3 JSONRequest 核心类

`JSONRequest` 是请求包装器，提供了便捷的请求构建方法。

#### 5.3.1 主要方法

##### setTag(String tag)

```java
public JSONRequest<M, L> setTag(String tag)
```

**功能**：设置请求标签

##### setVersion(Integer version)

```java
public JSONRequest<M, L> setVersion(Integer version)
```

**功能**：设置请求版本

##### setFormat(Boolean format)

```java
public JSONRequest<M, L> setFormat(Boolean format)
```

**功能**：设置是否格式化响应

### 5.4 JSONResponse 核心类

`JSONResponse` 是响应解析器，提供了响应数据的便捷访问方法。

#### 5.4.1 主要方法

##### getCode()

```java
default int getCode()
```

**功能**：获取响应状态码

##### getMsg()

```java
default String getMsg()
```

**功能**：获取响应消息

##### isSuccess()

```java
default boolean isSuccess()
```

**功能**：判断请求是否成功

##### getObject(Class<T> clazz)

```java
default <T> T getObject(Class<T> clazz)
```

**功能**：获取对象

##### getList(String key)

```java
default <T> List<T> getList(String key)
```

**功能**：获取列表

## 6. 总结

APIJSONORM 的核心功能模块包括：

1. **Parser 模块**：负责解析 JSON 请求
2. **SQLConfig 模块**：负责生成 SQL 语句
3. **SQLExecutor 模块**：负责执行 SQL 语句
4. **Verifier 模块**：负责验证请求权限和内容
5. **JSON 处理模块**：负责 JSON 序列化和反序列化

这些模块协同工作，实现了从 JSON 请求到数据库操作的完整流程。
